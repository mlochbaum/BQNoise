# IIR filters
# Filters are used to make some frequencies louder or quieter in order
# to change a sound's tone.
# Each one takes some parameters for its left argument and a signal on
# the right.

âŸ¨
  # 1-pole filters (f:frequency)
  Lp1, Hp1        #   f     low/high-pass

  # 2-pole filters (g:gain, w:width, Q decreases with width)
  Lp2, Hp2        #   f     Butterworth low/high-pass
  Lp2q,Hp2q,Bp2q  #   f Q   Butterworth low/high/band-pass with resonance
  Peak            # g f Q
  LShelf, HShelf  # g f Q?  low/high-shelf
  Notch           #   f w
  AllPass         # aâ€¿b     a+bi is complex with magnitude <1

  # Utilities
  NtoQ, QtoN      # Bandwidth â†â†’ Q for peak filters

  # Use Lp2âŸ2 and Hp2âŸ2 (4-pole Linkwitz-Riley) for crossovers

  # Other 2-pole low/high-pass filters (I never use these)
  # Filter2 generates Lp2 and Hp2 filters except the resonant ones
  # If the second argument is n then the filter should be called n
  # times and then gives a (2Ã—n)-pass filter
  Filter2
  # Critically damped and Bessel filters
  Lp2_CD,Hp2_CD, Lp2_BS,Hp2_BS
âŸ©â‡

"filter.bqn takes a single option namespace, or no arguments" ! 1â‰¥â‰ â€¢args
o â† â‰ â—¶âŸ¨â€¢Importâˆ˜"options.bqn", âŠ‘âŸ© â€¢args

# Generalized filtering
# ğ•© is the signal to filter
# ğ•¨ is âŸ¨result coefficients , ğ•© coefficientsâŸ©.
Filter â† {
  aâ€¿b â† 0Ã—coeffâ†ğ•¨  # accumulators and coefficients for input and result
  {
    aÂ«Ëœâ†©ğ•©
    râ†+Â´coeff+Â´âˆ˜Ã—Â¨aâ€¿b
    bÂ«Ëœâ†©r
    r
  }Â¨ ğ•©
}â‰1
_f â† { !âˆ˜0âŠ˜(ğ”½âŠ¸Filter) }

# Compute the frequency response from coefficients
#Response â† â‰â—‹<âŸœ(1âˆ¾-)â—‹âŒ½Â´ âŠ¸ ((|Â·Ã·Â´{+âŸœ(ğ•©âŠ¸Ã—)Â´ğ•¨}Â¨)â‰âˆâ€¿0) âŸœ (â‹†0i1Ã—Om)

# Trig (approximations for now)
SP â† (4âŠ¸Ã—Ã·5âŠ¸-) 4Ã—Â¬âŠ¸Ã—
Sin â† (âŠ¢-âˆ˜âŠ¢âŸ(>âŸœ1)Â·SP 1âŠ¸|) 2|Ã·âŸœÏ€
Cos â† Sin (Ï€Ã·2)âŠ¸-
Tan â† Sin Ã· Cos

Om â† (2Ã—Ï€)Ã—{ğ•©Ã·o.freq}
Tom â† Tan OmÃ·2Ë™

# 1-pole low-pass and high-pass filters
Lp1 â†     (â¥ŠÂ¨ Â·â‰âŸœÂ¬ 1+âŒ¾Ã·Om) _f
Hp1 â† ((-âŠ¸â‰ â‰â—‹< â¥Š) 1Ã·âˆ˜+Om) _f

# 2-pole *-pass
f2types â† "bw"â€¿"cd"â€¿"bessel"
Filter2 â† { typeâ€¿nPassesâ€¿isHighpass:
  t â† f2types âŠ‘âˆ˜âŠ <type
  ! 3 > t
  c â† tâ—¶âŸ¨4âˆš-âŸœ1 , âˆš1-Ëœâˆš , âˆš3Ã—0.5-ËœÂ·âˆš-âŸœ0.75âŸ© nPassesâˆš2 # cutoff frequency correction
  x â† t âŠ‘ âŸ¨âˆš2â€¿1 , 2â€¿1 , 3â€¿3âŸ©                         # p and g
  Clp2 â† {
    e â† Â¯1 âŠ‘ a â† ğ•¨ Ã— â‰âŸœ(Ã—Ëœ) Tom ğ•©
    b â† (1â€¿2â€¿1 âˆ¾Ëœ 2Ã—1-ËœÃ·e) Ã— e Ã· 1++Â´a
    Â¯3 (â†‘ â‰â—‹< â†“) (1-+Â´)âŠ¸âˆ¾ b
  }
  (isHighpass âŠ‘ âŸ¨
    x Clp2 Ã·âŸœc
    âŸ¨1â€¿Â¯1â€¿1, 1â€¿Â¯1âŸ© Ã— x Clp2 Â·{(o.freqÃ·2)-ğ•©}Ã—âŸœc
  âŸ©) _f
}

âŸ¨Lp2â€¿Hp2, Lp2_CDâ€¿Hp2_CD, Lp2_BSâ€¿Hp2_BSâŸ© â† <Ë˜f2types Filter2âˆ˜{ğ•¨â€¿1â€¿ğ•©}âŒœ â†•2

# Once more, with resonance
# Lp2q and Hp2q are identical to Lp2 and Hp2 when Q=Ã·âˆš2
Resfilt â† {
  OmâŠ¸(SinâŠ¸Ã·âŸœ(2âŠ¸Ã—) (+âŸœ1 Ã·Ëœ ğ• â‰â—‹< -âŸœ1â‰2âŠ¸Ã—) Cosâˆ˜âŠ£)Â´ _f
}
Lp2qâ€¿Hp2qâ€¿Bp2q â† ResfiltÂ¨ âŸ¨ 1âŠ¸-Ã·2â€¿1â€¿2Ë™ , 1âŠ¸+Ã·2â€¿Â¯1â€¿2Ë™ , Ã—âŸœ1â€¿0â€¿Â¯1 âŸ©

# Other 2-pole filters
Peak â† { gâ€¿fâ€¿q:
  k â† Tom f
  ab â† 1â€¿4â€¿0â€¿2â€¿3â€¿0 âŠ +âŸœ(kâŠ¸Ã—)Â´Â¨ Â¯2â€¿0â€¿2 <âŠ¸âˆ¾ {1â€¿ğ•©â€¿1}Â¨ â¥Šâ‰âŸœ- q Ã·Ëœ 10â‹†0âŒˆ-âŠ¸â‰gÃ·20
  3 (â†‘ â‰â—‹< -âˆ˜â†“) (1âŠ¸â†“ Ã· âŠ‘) ab
} _f
# Q to bandwidth and vice-versa for peaking filters
NtoQ â† {ğ•Šğ•©: (âˆšÃ·-âŸœ1)ğ•© ; ğ•Šâ¼ğ•©: -âŸœ1âŒ¾(Ã—Ëœ)âŠ¸+ 1+Ã·2Ã—Ã—Ëœğ•©} 2âŠ¸â‹†
QtoN â† NtoQâ¼

Shelf â† {
  # t is type: 1 for bass and Â¯1 for treble shelf
  tâ€¿gâ€¿fâ€¿q â† âˆ¾âŸœ(âˆš2)âŸ(3=â‰ ) ğ•©
  k â† Tom f
  v1 â† 10 â‹† t Ã— 0âŒˆ-âŠ¸â‰gÃ·40
  ab â† â¥Š 1â€¿0â€¿2âŠ¸âŠË˜ (Ã—Ëœ1âŒŠv1) Ã·Ëœ (kÃ—v1) {+âŸœ(ğ•¨âŠ¸Ã—)Â´ğ•©}âŒœ Â¯2â€¿0â€¿2 <âŠ¸âˆ¾ {1â€¿ğ•©â€¿1}Â¨ â‰âŸœ- q
  2 (â†“ â‰â—‹<â—‹âŒ½ -âˆ˜â†‘) (1âŠ¸â†“ Ã· âŠ‘) ab
} _f
# Shortcuts for low- and high-shelf
LShelf â†  1âŠ¸âˆ¾âŠ¸Shelf
HShelf â† Â¯1âŠ¸âˆ¾âŠ¸Shelf

Notch â† {
  # Filter with no gain outside of the notch due to A.G. Constantinides
  fâ€¿w â† ğ•©  # w is width of â‰¥3dB attenuation in Hz.
  câ†2Ã—Cos Om f â‹„ tâ†Tom w
  âŸ¨1,-c,1âŸ©â€¿âŸ¨t-1,câŸ© Ã· 1+t
} _f

AllPass â† (â‰â—‹<âŸœ(-âˆ˜âŒ½1âŠ¸â†“) âŸ¨1,Â¯2Ã—âŠ‘,+Â´Ã—ËœâŸ©{ğ•ğ•©}Â¨<) _f
